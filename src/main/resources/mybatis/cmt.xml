<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ddit.kixiv.gallery.mapper.GalleryDao">

	<select id="getCmtList" resultType="kr.ddit.kixiv.gallery.vo.RentCmtVO">
	    select 
	        a.cmt_id cmt_id, 
	        a.cmt_content cmt_content, 
	        a.cmt_date cmt_date, 
	        a.del_yn del_yn, 
	        a.board_id board_id,
	        a.user_id user_id, 
	        a.grp grp, 
	        a.rent_seq rent_seq, 
	        a.grps grps, 
	        a.grpl grpl, 
	        b.profile_img profile_img,
	        (select count(cmt_id) from good_bad where gb_status = 1 AND cmt_id = a.cmt_id) as good,
	        (select count(cmt_id) from good_bad where gb_status = 2 AND cmt_id = a.cmt_id) as bad,
	        (select count(cmt_id) from good_bad where gb_status not in (1,2) AND cmt_id = a.cmt_id) as etc,
	        b.nickname nickname
	    from cmt a
	    join users b on a.user_id = b.user_id
	    where a.rent_seq = #{rent_seq}
	    order by grp desc, case when a.grps=0 then 999999999999 else a.grps end desc
	</select>
	
	<insert id="writeCmtVO">
	    insert into cmt
	    (cmt_id, cmt_content, cmt_date, del_yn, user_id, grp, rent_seq, grps, grpl)
	    values ((select IFNULL(MAX(cmt_id),0) +1 from cmt), #{cmt_content}, NOW(), 'n', #{user_id}, (select IFNULL(MAX(cmt_id),0)+1 from cmt), #{rent_seq}, 0, 0)
	</insert>
	
	<update id="updCmtVO">
	    update cmt
	    set cmt_content = #{cmt_content} 
	    where cmt_id = #{cmt_id}
	</update>
	
	<delete id="delCmtVO">
	    update cmt
	    set del_yn = 'y'
	    where cmt_id = #{cmt_id} and grpl = 0
	</delete>
	
	<insert id="replyWriteCmtVO">
	    insert into cmt
	    (cmt_id, cmt_content, cmt_date, del_yn, user_id, grp, rent_seq, grps, grpl)
	    values ((select IFNULL(MAX(cmt_id),0) +1 from cmt), #{cmt_content}, NOW(), 'n', #{user_id}, #{grp}, #{rent_seq}, (select IFNULL(MAX(grps),0) +1 from cmt where rent_seq = #{rent_seq} and grp = #{grp}), 1)
	</insert>
	
	<update id="replyUpdCmtVO">
	    update cmt 
	    set cmt_content = #{cmt_content} 
	    where cmt_id = #{cmt_id}
	</update>
	
	<delete id="replyDelCmtVO">
	    delete from cmt 
	    where grpl = 1 and cmt_id = #{cmt_id}
	</delete>
	
	<insert id="goodAndBadVO">
	    insert into good_bad (gb_seq, user_id, cmt_id, gb_status)
	    values ((select IFNULL(MAX(gb_seq),0) +1 from good_bad), #{user_id}, #{cmt_id}, #{gb_status})
	    on duplicate key update gb_status = #{gb_status}
	</insert>
	
	<insert id="goodUps">
	    insert into good_bad (gb_seq, user_id, cmt_id, gb_status)
	    values ((select IFNULL(MAX(gb_seq),0) +1 from good_bad), #{user_id}, #{cmt_id}, #{gb_status})
	    on duplicate key update gb_status = #{gb_status}
	</insert>
	
	<select id="goodAndBadCnt" parameterType="kr.ddit.kixiv.gallery.vo.RentCmtVO" resultType="hashMap">
	    select cmt_id, gb_status, count(*) cnt
	    from good_bad
	    where cmt_id = #{cmt_id}
	    group by cmt_id, gb_status
	</select>
	
	<select id="gb_list" resultType="kr.ddit.kixiv.cmt.vo.GoodBadCntVo">
	    select go.cntg, bo.cntb
	    from (
	        select count(*) as cntg  
	        from cmt c
	        join good_bad g on c.cmt_id = g.cmt_id
	        where g.cmt_id = #{cmt_id} and g.gb_status = 1
	    ) go,
	    (
	        select count(*) cntb 
	        from cmt c
	        join good_bad g on c.cmt_id = g.cmt_id
	        where g.cmt_id = #{cmt_id} and g.gb_status = 2
	    ) bo
	</select>
	
	<select id="getStatus" resultType="String">
	    select gb_status 
	    from good_bad 
	    where cmt_id = #{cmt_id} and user_id = #{user_id}
	</select>
	
	<delete id="delGBFromUser">
	    delete from good_bad 
	    where user_id = #{user_id} and cmt_id = #{cmt_id}
	</delete>
</mapper>