<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ddit.kixiv.picture.mapper.PictureDao">

	<insert id="fileupdate">
		INSERT INTO picture
		(pic_num, pic_path, pic_name, thum_name, down_cnt, board_id, user_id)
		VALUES((select NVL(MAX(pic_num),0) +1 from picture), #{pic_path}, #{pic_name}, #{thum_name}, 0 ,#{board_id}, #{user_id})
	</insert>
	
		
	<select id="list" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE
	</select>
	
		
	<select id="picSearch" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE WHERE BOARD_ID = #{boradid}
	</select>
	
	
	<select id="picList" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE
	</select>
	
<!-- 	<select id="userPic" resultType="kr.ddit.kixiv.picture.vo.Picture"> -->
<!-- 		select pic_num, pic_path, pic_name, thum_name, down_cnt, board_id, user_id, cnt, likey_cnt -->
<!-- 		    from ( -->
<!-- 		         select A.PIC_NUM, A.PIC_PATH, A.PIC_NAME, A.THUM_NAME, A.DOWN_CNT, A.BOARD_ID, A.USER_ID, -->
<!-- 		            row_number() over(order by A.PIC_NUM desc) as rNum, (SELECT COUNT(*) FROM LIKEY B WHERE B.PIC_NUM = A.PIC_NUM) likey_cnt,	 -->
<!-- 		            (select COUNT(*) from LIKEY  where PIC_NUM = A.PIC_NUM AND USER_ID = #{user_id}) cnt -->
<!-- 		         from PICTURE A  -->
<!-- 		         where A.BOARD_ID = #{board_id} -->
<!-- 		    ) mb -->
<!-- 		where rNum between #{rowStart} and #{rowEnd} -->
<!-- 		    order by PIC_NUM desc -->
<!-- 	</select> -->
	<select id="userPic" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select pic_num, pic_path, pic_name, thum_name, down_cnt, board_id, user_id, cnt, likey_cnt
		    from (
		         select A.PIC_NUM, A.PIC_PATH, A.PIC_NAME, A.THUM_NAME, A.DOWN_CNT, A.BOARD_ID, A.USER_ID,
		            row_number() over(order by A.PIC_NUM desc) as rNum, (SELECT COUNT(*) FROM LIKEY B WHERE B.PIC_NUM = A.PIC_NUM) likey_cnt,	
		            (select COUNT(*) from LIKEY  where PIC_NUM = A.PIC_NUM AND USER_ID = #{user_id}) cnt
		         from PICTURE A 
		         where A.BOARD_ID = #{board_id}
		    ) mb
		where rNum between #{startPost} and #{endPost}
		order by PIC_NUM desc
	</select>
	
	
	<select id="listCount" resultType="int">
		<![CDATA[
		select count(*)
			 from PICTURE
	   		 where BOARD_ID = #{borad_id} AND PIC_NUM > 0
		
		]]>
	</select>

	
	<select id="OneSearch" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE WHERE PIC_NUM = #{pic_num}
	</select>
	
	<!-- <select id="list" resultType="kr.ddit.kixiv.picture.vo.Picture">
        SELECT A.PICID,A.USERID,A.PIC_SCORE,A.BORAD_ID,A.GANRE_NUM,A.FILENAME,A.PATHFILE,A.THUMBNAIL 
        FROM PICTURE A
        WHERE A.PICID = (
            SELECT MIN(B.PICID)
            FROM   PICTURE B
            WHERE  A.BORAD_ID = B.BORAD_ID 
        )
        AND A.GANRE_NUM = 1
	</select> -->
	
	<select id="newsImg" resultType="kr.ddit.kixiv.picture.vo.Picture">
        SELECT 	 P.PIC_NUM ,
		         P.PIC_PATH ,
		         P.PIC_NAME ,
		         P.THUM_NAME ,
		         P.DOWN_CNT ,
		         P.BOARD_ID ,
		         P.USER_ID ,
		         U.PROFILE_IMG
        FROM PICTURE P  , USERS U, PICBOARD B
        WHERE   P.USER_ID = U.USER_ID
        AND P.BOARD_ID =B.BOARD_ID
        AND B.DEL_YN = 'n'
		ORDER BY P.PIC_NUM DESC
	</select>
	
	<select id="veryLikeImg" resultType="kr.ddit.kixiv.picture.vo.Picture">
        SELECT  P.PIC_NUM ,
                P.PIC_PATH ,
                P.PIC_NAME ,
                P.THUM_NAME ,
                P.DOWN_CNT ,
                P.BOARD_ID ,
                P.USER_ID ,
                U.PROFILE_IMG,
                (SELECT COUNT(*) FROM LIKEY L WHERE P.PIC_NUM = L.PIC_NUM) likey_cnt
        FROM PICTURE P , USERS U, PICBOARD B
        WHERE   P.USER_ID = U.USER_ID
        AND P.BOARD_ID =B.BOARD_ID
        AND B.DEL_YN = 'n'
		ORDER BY likey_cnt DESC
		
	</select>
	
	<select id="followImg" resultType="kr.ddit.kixiv.picture.vo.Picture">
        SELECT  P.PIC_NUM ,
            P.PIC_PATH ,
            P.PIC_NAME ,
            P.THUM_NAME ,
            P.DOWN_CNT ,
            P.BOARD_ID ,
            P.USER_ID ,
            U.PROFILE_IMG
        FROM PICTURE P , USERS U,  PICBOARD B
        where p.user_id = u.user_id
        AND P.BOARD_ID =B.BOARD_ID
        AND B.DEL_YN = 'n'
        and P.USER_ID in (SELECT F.FROM_ID FROM FOLLOWING F  WHERE F.TO_ID =  'tkd753')
        ORDER BY P.PIC_NUM DESC
	</select>
	
	<select id="myImgs" resultType="kr.ddit.kixiv.picture.vo.Picture">
        SELECT  P.PIC_NUM ,
            P.PIC_PATH ,
            P.PIC_NAME ,
            P.THUM_NAME ,
            P.DOWN_CNT ,
            P.BOARD_ID ,
            P.USER_ID ,
            U.PROFILE_IMG
        FROM PICTURE P , USERS U, PICBOARD B
        WHERE p.user_id = u.user_id
        AND p.user_id = 'tkd753'
        AND P.BOARD_ID =B.BOARD_ID
        AND B.DEL_YN = 'n'
		ORDER BY P.PIC_NUM DESC
	</select>
	
	<select id="hashTag" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE P
		where BOARD_ID in (select board_id from TAGLIST where TAG_ID = #{tag_id})
	</select>
	
	<!-- 편집 -->
	<select id="totalCount" resultType="int">
		select count(*)
		from picture
		where board_id = #{board_id}
	</select>
	
	<!-- 페이징 처리 -->
	<select id="getListCnt" resultType="int">
      select count(*)
		from PICTURE P, PICBOARD B
        WHERE P.BOARD_ID =B.BOARD_ID
        AND B.DEL_YN = 'n'
	</select>
	
	<select id="getList" resultType="kr.ddit.kixiv.picture.vo.Picture">
 	    select  PIC_NUM , PIC_PATH ,PIC_NAME ,THUM_NAME ,DOWN_CNT , BOARD_ID , USER_ID , PROFILE_IMG   
	       from (SELECT  P.PIC_NUM ,P.PIC_PATH , P.PIC_NAME , P.THUM_NAME , P.DOWN_CNT , P.BOARD_ID , P.USER_ID , U.PROFILE_IMG,
	       row_number() over(order by P.PIC_NUM desc)as rNum
	        FROM PICTURE P , USERS U, PICBOARD B
	        WHERE   P.USER_ID = U.USER_ID
                and p.BOARD_ID = B.BOARD_ID
                and B.DEL_YN = 'n' 
            )mb 
	    where rNum between #{startNum} and #{endNum}
	    order by PIC_NUM desc
	</select>
	
	<select id="veryLikeImgs" resultType="kr.ddit.kixiv.picture.vo.Picture">
        select  PIC_NUM , PIC_PATH ,PIC_NAME ,THUM_NAME ,DOWN_CNT , BOARD_ID , USER_ID , PROFILE_IMG ,likey_cnt
		from (
			SELECT  P.PIC_NUM ,P.PIC_PATH ,P.PIC_NAME ,P.THUM_NAME ,P.DOWN_CNT ,P.BOARD_ID , P.USER_ID ,U.PROFILE_IMG,B.DEL_YN,
	                (SELECT COUNT(*) FROM LIKEY L WHERE P.PIC_NUM = L.PIC_NUM) likey_cnt,
	                row_number() over(order by P.PIC_NUM desc)as rNum
	        FROM PICTURE P , USERS U, PICBOARD B
	        WHERE   P.USER_ID = U.USER_ID
             and p.BOARD_ID = B.BOARD_ID
             and B.DEL_YN = 'n' 
            )mb
        where rNum between #{startNum} and #{endNum}
    ORDER BY likey_cnt DESC
	</select>
	
	<select id="getFollowListCnt" resultType="int">
      select count(*) from (
       	 SELECT  P.PIC_NUM ,
	            P.PIC_PATH ,
	            P.PIC_NAME ,
	            P.THUM_NAME ,
	            P.DOWN_CNT ,
	            P.BOARD_ID ,
	            P.USER_ID ,
	            U.PROFILE_IMG,
                B.DEL_YN
        FROM PICTURE P , USERS U, PICBOARD B
        WHERE p.user_id = u.user_id 
            and P.USER_ID in  (SELECT F.FROM_ID FROM FOLLOWING F  WHERE F.TO_ID = 'tkd753' and  P.USER_ID = U.USER_ID )
            and P.BOARD_ID = B.BOARD_ID
            and B.DEL_YN = 'n'
         )mb
	</select>
	
	<select id="getMyListCnt" resultType="int">
		SELECT count(*) 
        FROM PICTURE P, PICBOARD B
        	WHERE  P.USER_ID =  'tkd753'
            AND P.BOARD_ID =B.BOARD_ID
            AND B.DEL_YN = 'n'
	</select>
	
	<select id="followImgs" resultType="kr.ddit.kixiv.picture.vo.Picture">
           select  PIC_NUM, PIC_PATH, PIC_NAME, THUM_NAME, DOWN_CNT, BOARD_ID, USER_ID, PROFILE_IMG
	        	from(
		            SELECT  P.PIC_NUM , P.PIC_PATH ,P.PIC_NAME , P.THUM_NAME ,P.DOWN_CNT ,P.BOARD_ID , P.USER_ID ,U.PROFILE_IMG, B.DEL_YN
		            ,row_number() over(order by P.PIC_NUM desc)as rNum
		            FROM PICTURE P , USERS U, PICBOARD B
		            WHERE   p.user_id = u.user_id 
		            and p.user_id = u.user_id 
	                and P.USER_ID in  (SELECT F.FROM_ID FROM FOLLOWING F  WHERE F.TO_ID = 'tkd753') 
                    and P.USER_ID = U.USER_ID 
                    and P.BOARD_ID = B.BOARD_ID
                    and B.DEL_YN = 'n'
		        )mb
	        where rNum between #{startNum} and #{endNum}
			ORDER BY PIC_NUM DESC
	</select>
	
	<select id="getPicture" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select* from PICTURE where board_id = #{board_id}
	</select>
	
	<delete id="deleteChangeImg">
		   DELETE FROM PICTURE 
		   WHERE pic_num = #{pic_num}
	</delete>
	
	<delete id="deletePicture">
			DELETE FROM PICTURE 
		   WHERE board_id = #{board_id}
	</delete>
	
</mapper>