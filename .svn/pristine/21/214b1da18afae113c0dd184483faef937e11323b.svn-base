<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ddit.kixiv.cmt.mapper.CmtDao">

	<!-- 갯수  -->
	<!-- 해당 게시글의 총 댓글 or 답글 갯수 -->
	<select id="reply_count" resultType="integer">
		select count(*) 
		from cmt
		where  BOARD_ID = #{board_id} and del_yn = 'n'
	</select>
	
	<!-- 리스트 -->	
	<!-- 댓글 리스트 가져오기 -->
	<select id="picutre_replyList" resultType="kr.ddit.kixiv.cmt.vo.CmtVo">
        
<!-- 	 	select r.cmt_id, r.board_id, r.grp, r.grpl, r.user_id, r.cmt_content, TO_CHAR(TO_DATE(cmt_date,'YYYY-MM-DD')) wdate, (sysdate - cmt_date) wgap , u.profile_img, u.nickname 
	    	from CMT r left outer join users u
	  		  on r.user_id = u.user_id
	   		 where r.board_id = #{board_id}
	  	  order by grp asc, grps desc -->
		
		
	 	select r.cmt_id, r.board_id, r.grp, r.grpl, r.GRPS, r.user_id, r.cmt_content, TO_CHAR(cmt_date,'YYYY-MM-DD') cmt_date, (sysdate - cmt_date) wgap , u.profile_img, u.nickname 
	    	from CMT r left outer join users u
	  		  on r.user_id = u.user_id
	   		 where r.board_id = #{board_id}
	  	  order by grp asc, case when r.GRPS=0 then 999999999999  else r.GRPS end desc
		
	</select>
	
	<!-- 작성 쿼리 -->
	<!-- 댓글 쓰기 -->
	<insert id="picture_reply_write">
	    insert into cmt
	    (cmt_id, cmt_content, cmt_date, del_yn, board_id, user_id, grp, grps, grpl)
	    values((select NVL(MAX(cmt_id),0) +1 from cmt), #{cmt_content}, sysdate, 'n', #{board_id}, #{user_id}, (select NVL(MAX(cmt_id),0) +1 from cmt), 0, 0)
	</insert>	
	
	
	<!-- 답글 쓰기 -->
	<insert id="picture_rereply_write">
	    insert into cmt
			(cmt_id, cmt_content, cmt_date, del_yn, board_id, user_id, grp, grps, grpl)
		values
			((select NVL(MAX(cmt_id),0) +1 from cmt),
			#{cmt_content}, 
			sysdate,
			'n', 
			#{board_id}, 
			#{user_id}, 
			#{grp},
			(select NVL(MAX(grps),0) +1 from cmt where board_id = #{board_id} and grp = #{grp}),
			#{grpl})
	</insert>
	
	<!-- 삭제 쿼리 -->
	<!-- 모댓글의 답글수를 카운트 -->
	<select id="picture_count_rereply"  resultType="int">
	    select count(cmt_id)
	    from cmt
	    where cmt_id != #{cmt_id} and grp = #{cmt_id}
	</select>
	
	<!-- 모댓글 삭제 - 답글 없음 -->
	<delete id="picture_reply_delete">
	    delete from cmt
	    where cmt_id=#{cmt_id}
	</delete>
	
	<!-- 모댓글 삭제 - 답글 있음 -->
	<update id="picture_reply_not_delete">
        update cmt set cmt_content=' ', del_yn='y'
	    where cmt_id= #{cmt_id}
	</update>
	
	<!-- 답글수를 카운트 -->
	<select id="picture_count_rereply_fromrereply" resultType="int">
	    select count(cmt_id)
	    from cmt
	    where cmt_id != #{grp} and grp = #{grp}
	</select>
		
			
	<!-- 모댓글이 삭제된 댓글일때 그에 딸린 답글들이 모두삭제되면 테이블에서 완전히 삭제한다 -->
	<delete id="picture_reply_delete_after_rereply_delete">
	    delete from cmt
	    where cmt_content=' ' and grp=#{grp}
	</delete>
	
	
</mapper>