<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ddit.kixiv.gallery.mapper.GalleryDao">
				   
	<select id="getGalleryRentList" resultType="HashMap">
		SELECT S.RNUM, S.rent_seq rent_seq, S.gallery_name gallery_name
		        , S.gallery_zip gallery_zip , S.gallery_thum gallery_thum
		        , S.gallery_add1 gallery_add1, S.gallery_add2 gallery_add2, S.gallery_img
		        , S.rent_sdate rent_sdate, S.rent_edate rent_edate, S.user_id user_id, S.rent_status rent_status
  		FROM(
	        SELECT ROWNUM RNUM, T.*
	          FROM (
	                select b.rent_seq rent_seq
					     , a.gallery_name gallery_name
					     , a.gallery_zip gallery_zip
					     , a.gallery_thum gallery_thum
					     , a.gallery_add1 gallery_add1
					     , a.gallery_add2 gallery_add2
					     , a.gallery_img
					     , to_char(b.rent_sdate, 'yyyy-mm-dd') rent_sdate
					     , to_char(b.rent_edate, 'yyyy-mm-dd') rent_edate
					     , a.user_id user_id
					     , b.rent_status rent_status
					  from gallery a, rent b
					 where a.gallery_num = b.gallery_num
	                ) T
	          where T.gallery_name like '%' || #{keyword} || '%'
	          ) S
	 WHERE S.RNUM BETWEEN TO_NUMBER(#{pageNum})*10-9 AND TO_NUMBER(#{pageNum})*10
	</select>
	
	<select id="count" resultType="int">
 		SELECT COUNT(*) CNT FROM GALLERY
 	</select>
 	
 	<select id="selectSearchCount" resultType="int">
 		select count(*) CNT 
 		  from GALLERY
 		 where gallery_name like '%' || #{keyword} || '%'
 	</select>
 	
 	<select id="getRent" resultType="map">
 		select 
		    a.rent_seq "rent_seq", 
		    to_char(a.rent_sdate,'YYYY-MM-DD') "rent_sdate",
		    to_char(a.rent_edate,'YYYY-MM-DD') "rent_edate", 
		    a.rent_content "rent_content", 
		    a.fund_yn "fund_yn",
		    a.rent_price "rent_price", 
		    a.rent_status "rent_status", 
		    a.rentdate "rentdate", 
		    a.del_yn "del_yn", 
		    a.gallery_num "gallery_num",
		    a.rent_img "rent_img",
		    b.gallery_name "gallery_name", 
		    b.gallery_zip "gallery_zip", 
		    b.gallery_add1 "gallery_add1", 
		    b.gallery_add2 "gallery_add2", 
		    b.gallery_tel "gallery_tel", 
		    b.gallery_intro "gallery_intro",  
		    b.gallery_img "gallery_img", 
		    b.homepage "homepage", 
		    b.user_id "user_id",
		    c.phone "phone"
		from
		    rent a, gallery b, users c
		where 
		    a.gallery_num = b.gallery_num
		and
		    rent_seq = #{rent_seq}
		and
			b.user_id = c.user_id    
 	</select>
 	
 	<select id="galleryList" resultType="kr.ddit.kixiv.gallery.vo.GalleryVO">
 		select gallery_num, gallery_name, gallery_zip, gallery_add1, gallery_add2, gallery_tel, 
 		gallery_intro, gallery_img, gallery_path, gallery_thum, homepage, user_id, delete_yn
		from gallery
		where user_id=#{user_id}
		and delete_yn='n'
		order by gallery_num
 	</select>
 	
 	<select id="addressCheck" resultType="kr.ddit.kixiv.gallery.vo.GalleryVO">
 		select * from gallery
 		where gallery_add1=#{gallery_add1}
 	</select>
 	
 	<insert id="addGallery">
 		insert into gallery(gallery_num, gallery_name, gallery_zip, gallery_add1, gallery_add2, gallery_tel, 
 		gallery_intro, gallery_img, gallery_path, gallery_thum, user_id, delete_yn, homepage)
		values((select max(gallery_num) from gallery)+1, #{gallery_name}, #{gallery_zip}, #{gallery_add1}, #{gallery_add2}, #{gallery_tel}, #{gallery_intro}, #{gallery_img}, 'path', 'thum', #{user_id}, 'n',
		<choose>
			<when test="homepage == null">
				'')
			</when>
			<otherwise>
				#{homepage})
			</otherwise>
		</choose>
 	</insert>

 	<update id="modifyGallery">
 		update gallery 
		set gallery_zip=#{gallery_zip}, 
		    gallery_add1=#{gallery_add1}, 
		    gallery_add2=#{gallery_add2}, 
		    gallery_tel=#{gallery_tel},
		    gallery_intro=#{gallery_intro}, 
		    gallery_img=#{gallery_img},
		    homepage=#{homepage}
		where gallery_num=#{gallery_num}
 	</update>
 	
 	<select id="myGalleryDetail" resultType="kr.ddit.kixiv.gallery.vo.GalleryVO">
 		select * from gallery
 		where gallery_num=#{gallery_num}
 	</select>
 	
 	<update id="deleteGallery">
 		update gallery
 		set delete_yn='y'
 		where gallery_num=#{gallery_num}
 	</update>
 	
 	<select id="getPayVO" resultType="kr.ddit.kixiv.gallery.vo.GalleryRentVO">
		select    
	            a.rent_num,
	            a.cancel_yn,
	            a.rent_tel,
	            a.rent_seq, 
	            a.user_id,
	            a.rent_req_date,
	            a.rent_name,
	            a.rent_email,
	            a.rent_imp_uid,
	            a.rent_pg,
	            (select b.rent_price from rent b where b.rent_seq = a.rent_seq) rent_price,
	            (select c.name from users c where c.user_id = a.user_id) name,
	            b.rent_status
	    from gallery_rent a, rent b
	   where a.rent_imp_uid = #{rent_imp_uid}
	     and a.rent_seq = b.rent_seq
 	</select>
 	
 	<insert id="rentReqVO">
 		insert 
		  into gallery_rent
		       (rent_num, cancel_yn, rent_tel, rent_seq, user_id, rent_req_date, rent_name, rent_email, rent_imp_uid, rent_pg)
		values (#{rent_num}, 'n', #{rent_tel}, #{rent_seq}, #{user_id}, sysdate, #{rent_name}, #{rent_email}, #{rent_imp_uid}, '이니시스')
 	</insert>
	 
	<update id="rentReqStVO">
		update rent
		   set rent_status = 'n'
		 where rent_seq = #{rent_seq}
	</update>
 	
 	<update id="rentRefundVO">
		update gallery_rent
		   set cancel_yn = 'y'
		 where rent_num = #{rent_num}
	</update>
	
	<select id="galleryRentUserVO" resultType="kr.ddit.kixiv.gallery.vo.GalleryRentVO"> 
	    select 
	        a.rent_num rent_num, 
	        a.cancel_yn cancel_yn, 
	        a.rent_tel rent_tel, 
	        a.rent_seq rent_seq, 
	        a.user_id user_id, 
	        a.rent_req_date rent_req_date, 
	        a.rent_name rent_name, 
	        a.rent_email rent_email, 
	        a.rent_imp_uid rent_imp_uid, 
	        a.rent_pg rent_pg,
	        g.gallery_name gallery_name,
	        b.rent_status rent_status,
	        b.rent_sdate rent_sdate,
	        b.rent_edate rent_edate,
	        b.rent_price rent_price,
	        (select c.phone from users c where c.user_id = a.user_id) phone,
	        (select c.email from users c where c.user_id = a.user_id) email,
	        (select c.name from users c where c.user_id = a.user_id) name
	  from gallery_rent a, rent b, gallery g 
	 where 1 = 1 
	   and a.user_id = #{user_id}
	   and a.rent_seq = b.rent_seq
	   and g.gallery_num = b.gallery_num
	</select>
	
	<!-- 갤러리 회원 갤러리 렌트글 리스트 갯수 -->
	<select id="totalCount" resultType="int">
		SELECT count(*)
		FROM(
	 		select b.rent_seq rent_seq
               	, a.gallery_name gallery_name
               	, a.gallery_zip gallery_zip
               	, a.gallery_thum gallery_thum
               	, a.gallery_add1 gallery_add1
               	, a.gallery_add2 gallery_add2
               	, to_char(b.rent_sdate, 'yyyy-mm-dd') rent_sdate
               	, to_char(b.rent_edate, 'yyyy-mm-dd') rent_edate
               	, a.user_id user_id
               	, b.rent_status rent_status
           	from gallery a, rent b
          	where a.gallery_num = b.gallery_num
           	and user_id=#{user_id}
		)
		<if test="keyword.equals('today')">
	    	where rent_sdate = to_char(sysdate, 'YYYY-MM-DD')
	    </if>
	    <if test="keyword.equals('week')">
	    	where to_date(rent_sdate) between (SELECT TRUNC(sysdate, 'iw') FROM DUAL) and (SELECT TRUNC(sysdate, 'iw')+6 FROM DUAL)
	    </if>
	    <if test="keyword.equals('month')">
	    	where substr(rent_sdate, 1, 7) = to_char(sysdate, 'YYYY-MM')
	    </if>
	    <if test="keyword.equals('year')">
	    	where substr(rent_sdate, 1, 4) = to_char(sysdate, 'YYYY')
	    </if>
	    <if test="keyword.equals('period')">
	    	where to_date(rent_sdate) between to_date(#{rent_period_start},'YYYY-MM-DD') and to_date(#{rent_period_end},'YYYY-MM-DD')
	    </if>
 	</select>
 	 
	<!-- 갤러리 회원 갤러리 렌트글 리스트 -->
	<select id="myGalleryRent" resultType="HashMap">
    SELECT S.RNUM, S.rent_seq rent_seq, S.gallery_name gallery_name
         , S.gallery_zip gallery_zip , S.gallery_thum gallery_thum
         , S.gallery_add1 gallery_add1, S.gallery_add2 gallery_add2, S.gallery_img
         , S.rent_sdate rent_sdate, S.rent_edate rent_edate, S.user_id user_id, S.rent_status rent_status
    FROM(
      	SELECT ROWNUM RNUM, T.*
       	FROM (
           	select b.rent_seq rent_seq
               	, a.gallery_name gallery_name
               	, a.gallery_zip gallery_zip
               	, a.gallery_thum gallery_thum
               	, a.gallery_add1 gallery_add1
               	, a.gallery_add2 gallery_add2
               	, a.gallery_img
               	, to_char(b.rent_sdate, 'yyyy-mm-dd') rent_sdate
               	, to_char(b.rent_edate, 'yyyy-mm-dd') rent_edate
               	, a.user_id user_id
               	, b.rent_status rent_status
           	from gallery a, rent b
          	where a.gallery_num = b.gallery_num
           	and user_id=#{user_id}
           ) T
	    <if test="keyword.equals('today')">
	    	where rent_sdate = to_char(sysdate, 'YYYY-MM-DD')
	    </if>
	    <if test="keyword.equals('week')">
	    	where to_date(rent_sdate) between (SELECT TRUNC(sysdate, 'iw') FROM DUAL) and (SELECT TRUNC(sysdate, 'iw')+6 FROM DUAL)
	    </if>
	    <if test="keyword.equals('month')">
	    	where substr(rent_sdate, 1, 7) = to_char(sysdate, 'YYYY-MM')
	    </if>
	    <if test="keyword.equals('year')">
	    	where substr(rent_sdate, 1, 4) = to_char(sysdate, 'YYYY')
	    </if>
	    <if test="keyword.equals('period')">
	    	where to_date(rent_sdate) between to_date(#{rent_period_start},'YYYY-MM-DD') and to_date(#{rent_period_end},'YYYY-MM-DD')
	    </if>       	
    ) S
    WHERE S.RNUM BETWEEN TO_NUMBER(#{pageNum})*10-9 AND TO_NUMBER(#{pageNum})*10
	</select>
 	
	<!-- 일반회원 갤러리 렌트 리스트 갯수 -->
	<select id="getMyRentReqListCnt" resultType="int">
		SELECT count(*)
	    FROM (
	        select to_char(b.rent_req_date, 'yyyy-mm-dd') rent_req_date
	         , a.user_id
	        from gallery a, gallery_rent b, rent c
	        where a.gallery_num = c.gallery_num
	        and b.user_id=#{user_id}
	        and c.rent_seq = b.rent_seq
	    ) T
	    <if test="keyword.equals('today')">
	    	where rent_req_date = to_char(sysdate, 'YYYY-MM-DD')
	    </if>
	    <if test="keyword.equals('week')">
	    	where to_date(rent_req_date) between (SELECT TRUNC(sysdate, 'iw') FROM DUAL) and (SELECT TRUNC(sysdate, 'iw')+6 FROM DUAL)
	    </if>
	    <if test="keyword.equals('month')">
	    	where substr(rent_req_date, 1, 7) = to_char(sysdate, 'YYYY-MM')
	    </if>
	    <if test="keyword.equals('year')">
	    	where substr(rent_req_date, 1, 4) = to_char(sysdate, 'YYYY')
	    </if>
	    <if test="keyword.equals('period')">
	    	where to_date(rent_req_date) between to_date(#{rent_period_start},'YYYY-MM-DD') and to_date(#{rent_period_end},'YYYY-MM-DD')
	    </if>
	</select>
	
	<!-- 일반회원 갤러리 렌트 리스트 -->
	<select id="getMyRentReqList" resultType="HashMap">
		SELECT S.RNUM, S.gallery_name gallery_name, S.rent_req_date rent_req_date
				, S.rent_status rent_status , S.rent_num rent_num
				, S.rent_imp_uid rent_imp_uid, S.cancel_yn, S.user_id user_id
		FROM(
		    SELECT ROWNUM RNUM, T.*
		    FROM (
		        select a.gallery_name gallery_name
		         , to_char(b.rent_req_date, 'yyyy-mm-dd') rent_req_date
		         , c.rent_status rent_status
		         , b.rent_num rent_num
		         , b.rent_imp_uid rent_imp_uid
		         , b.cancel_yn
		         , a.user_id user_id
		        from gallery a, gallery_rent b, rent c
		        where a.gallery_num = c.gallery_num
		        and b.user_id=#{user_id}
		        and c.rent_seq = b.rent_seq
		    ) T
		    <if test="keyword.equals('today')">
		    	where rent_req_date = to_char(sysdate, 'YYYY-MM-DD')
		    </if>
		    <if test="keyword.equals('week')">
		    	where to_date(rent_req_date) between (SELECT TRUNC(sysdate, 'iw') FROM DUAL) and (SELECT TRUNC(sysdate, 'iw')+6 FROM DUAL)
		    </if>
		    <if test="keyword.equals('month')">
		    	where substr(rent_req_date, 1, 7) = to_char(sysdate, 'YYYY-MM')
		    </if>
		    <if test="keyword.equals('year')">
		    	where substr(rent_req_date, 1, 4) = to_char(sysdate, 'YYYY')
		    </if>
		    <if test="keyword.equals('period')">
		    	where to_date(rent_req_date) between to_date(#{rent_period_start},'YYYY-MM-DD') and to_date(#{rent_period_end},'YYYY-MM-DD')
		    </if>
		)S
		WHERE S.RNUM BETWEEN TO_NUMBER(#{pageNum})*10-9 AND TO_NUMBER(#{pageNum})*10
	</select>
	
	<select id="oneitemPick" resultType="kr.ddit.kixiv.gallery.vo.GalleryRentVO">
		select u.name, s.rent_name, g.gallery_name, r.rent_sdate, r.rent_edate, r.rent_price, s.rent_imp_uid
			from gallery_rent s, rent r, gallery g, users u
		where  s.rent_num = #{rent_num}
		    and s.rent_seq = r.rent_seq 
		    and g.user_id = u.user_id
		    and g.gallery_num = r.gallery_num
	</select>

</mapper>