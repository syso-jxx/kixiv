<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ddit.kixiv.picture.mapper.PictureDao">

	<insert id="fileupdate">
		INSERT INTO picture
		(pic_num, pic_path, pic_name, thum_name, down_cnt, board_id, user_id)
		VALUES((select NVL(MAX(pic_num),0) +1 from picture), #{pic_path}, #{pic_name}, #{thum_name}, 0 ,#{board_id}, #{user_id})
	</insert>
	
		
	<select id="list" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE
	</select>
	
		
	<select id="picSearch" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE WHERE BOARD_ID = #{boradid}
	</select>
	
	
	<select id="picList" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE
	</select>
	
<!-- 	<select id="userPic" resultType="kr.ddit.kixiv.picture.vo.Picture"> -->
<!-- 		select pic_num, pic_path, pic_name, thum_name, down_cnt, board_id, user_id, cnt, likey_cnt -->
<!-- 		    from ( -->
<!-- 		         select A.PIC_NUM, A.PIC_PATH, A.PIC_NAME, A.THUM_NAME, A.DOWN_CNT, A.BOARD_ID, A.USER_ID, -->
<!-- 		            row_number() over(order by A.PIC_NUM desc) as rNum, (SELECT COUNT(*) FROM LIKEY B WHERE B.PIC_NUM = A.PIC_NUM) likey_cnt,	 -->
<!-- 		            (select COUNT(*) from LIKEY  where PIC_NUM = A.PIC_NUM AND USER_ID = #{user_id}) cnt -->
<!-- 		         from PICTURE A  -->
<!-- 		         where A.BOARD_ID = #{board_id} -->
<!-- 		    ) mb -->
<!-- 		where rNum between #{rowStart} and #{rowEnd} -->
<!-- 		    order by PIC_NUM desc -->
<!-- 	</select> -->
	<select id="userPic" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select pic_num, pic_path, pic_name, thum_name, down_cnt, board_id, user_id, cnt, likey_cnt
		    from (
		         select A.PIC_NUM, A.PIC_PATH, A.PIC_NAME, A.THUM_NAME, A.DOWN_CNT, A.BOARD_ID, A.USER_ID,
		            row_number() over(order by A.PIC_NUM desc) as rNum, (SELECT COUNT(*) FROM LIKEY B WHERE B.PIC_NUM = A.PIC_NUM) likey_cnt,	
		            (select COUNT(*) from LIKEY  where PIC_NUM = A.PIC_NUM AND USER_ID = #{user_id}) cnt
		         from PICTURE A 
		         where A.BOARD_ID = #{board_id}
		    ) mb
		where rNum between #{startPost} and #{endPost}
		order by PIC_NUM desc
	</select>
	
	
	<select id="listCount" resultType="int">
		<![CDATA[
		select count(*)
			 from PICTURE
	   		 where BOARD_ID = #{borad_id} AND PIC_NUM > 0
		
		]]>
	</select>

	
	<select id="OneSearch" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE WHERE PIC_NUM = #{pic_num}
	</select>
	
	<!-- <select id="list" resultType="kr.ddit.kixiv.picture.vo.Picture">
        SELECT A.PICID,A.USERID,A.PIC_SCORE,A.BORAD_ID,A.GANRE_NUM,A.FILENAME,A.PATHFILE,A.THUMBNAIL 
        FROM PICTURE A
        WHERE A.PICID = (
            SELECT MIN(B.PICID)
            FROM   PICTURE B
            WHERE  A.BORAD_ID = B.BORAD_ID 
        )
        AND A.GANRE_NUM = 1
	</select> -->
	
	<select id="newsImg" resultType="kr.ddit.kixiv.picture.vo.Picture">
		WITH T AS(
		SELECT PIC_NUM, PIC_PATH, PIC_NAME, DOWN_CNT, BOARD_ID, USER_ID, PROFILE_IMG FROM(
		        SELECT   P.PIC_NUM ,
				         P.PIC_PATH ,
				         P.PIC_NAME ,
				         P.THUM_NAME ,
				         P.DOWN_CNT ,
				         P.BOARD_ID ,
				         P.USER_ID ,
				         U.PROFILE_IMG
		        FROM PICTURE P  , USERS U, PICBOARD B
		        WHERE   P.USER_ID = U.USER_ID
		        AND P.BOARD_ID =B.BOARD_ID
		        AND B.DEL_YN = 'n'
		        Order BY BOARD_ID DESC
		    )
		)
		SELECT * FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)
	</select>
	
	<select id="veryLikeImg" resultType="kr.ddit.kixiv.picture.vo.Picture">
		WITH T AS(
			SELECT PIC_NUM, PIC_PATH, PIC_NAME, DOWN_CNT, BOARD_ID, USER_ID, PROFILE_IMG FROM(
	            SELECT  P.PIC_NUM ,
	                    P.PIC_PATH ,
	                    P.PIC_NAME ,
	                    P.THUM_NAME ,
	                    P.DOWN_CNT ,
	                    P.BOARD_ID ,
	                    P.USER_ID ,
	                    U.PROFILE_IMG,
	                    (SELECT COUNT(*) FROM LIKEY L WHERE P.PIC_NUM = L.PIC_NUM) likey_cnt
	            FROM PICTURE P , USERS U, PICBOARD B
	            WHERE   P.USER_ID = U.USER_ID
	            AND P.BOARD_ID =B.BOARD_ID
	            AND B.DEL_YN = 'n'
	            ORDER BY likey_cnt DESC
			    )
		)
		SELECT * FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)

		
	</select>
	
	<select id="followImg" resultType="kr.ddit.kixiv.picture.vo.Picture">
	WITH T AS(
		SELECT PIC_NUM, PIC_PATH, PIC_NAME, DOWN_CNT, BOARD_ID, USER_ID, PROFILE_IMG FROM(
        SELECT  P.PIC_NUM ,
            P.PIC_PATH ,
            P.PIC_NAME ,
            P.THUM_NAME ,
            P.DOWN_CNT ,
            P.BOARD_ID ,
            P.USER_ID ,
            U.PROFILE_IMG
        FROM PICTURE P , USERS U,  PICBOARD B
        where p.user_id = u.user_id
        AND P.BOARD_ID =B.BOARD_ID
        AND B.DEL_YN = 'n'
        and P.USER_ID in (SELECT F.FROM_ID FROM FOLLOWING F  WHERE F.TO_ID = #{user_id})
        ORDER BY P.PIC_NUM DESC
		    )
		)
		SELECT * FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
	)
	</select>
	
	<select id="myImgs" resultType="kr.ddit.kixiv.picture.vo.Picture">
 	WITH T AS(
	
        SELECT  P.PIC_NUM ,
            P.PIC_PATH ,
            P.PIC_NAME ,
            P.THUM_NAME ,
            P.DOWN_CNT ,
            P.BOARD_ID ,
            P.USER_ID ,
            U.PROFILE_IMG
        FROM PICTURE P , USERS U, PICBOARD B
        WHERE p.user_id = u.user_id
        AND p.user_id = #{user_id}
        AND P.BOARD_ID =B.BOARD_ID
        AND B.DEL_YN = 'n'
		ORDER BY P.PIC_NUM DESC
		    
		)
		SELECT * FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)

	</select>
	
	<select id="hashTag" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select * from PICTURE P
		where BOARD_ID in (select board_id from TAGLIST where TAG_ID = #{tag_id})
	</select>
	
	<!-- 편집 -->
	<select id="totalCount" resultType="int">
		select count(*)
		from picture
		where board_id = #{board_id}
	</select>
	
	<!-- 페이징 처리 -->
	<select id="getListCnt" resultType="int">
		 WITH T AS(
		SELECT PIC_NUM, PIC_PATH, PIC_NAME, DOWN_CNT, BOARD_ID, USER_ID, PROFILE_IMG FROM(
		        SELECT   P.PIC_NUM ,
				         P.PIC_PATH ,
				         P.PIC_NAME ,
				         P.THUM_NAME ,
				         P.DOWN_CNT ,
				         P.BOARD_ID ,
				         P.USER_ID ,
				         U.PROFILE_IMG
		        FROM PICTURE P  , USERS U, PICBOARD B
		        WHERE   P.USER_ID = U.USER_ID
		        AND P.BOARD_ID =B.BOARD_ID
		        AND B.DEL_YN = 'n'
		    )
		)
		SELECT count(*) FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)
	</select>
	
	<select id="getList" resultType="kr.ddit.kixiv.picture.vo.Picture">
	WITH T AS(
		SELECT PIC_NUM , PIC_PATH ,PIC_NAME ,THUM_NAME ,DOWN_CNT , BOARD_ID , USER_ID , PROFILE_IMG  FROM(
 	    select  PIC_NUM , PIC_PATH ,PIC_NAME ,THUM_NAME ,DOWN_CNT , BOARD_ID , USER_ID , PROFILE_IMG   
	       from (SELECT  P.PIC_NUM ,P.PIC_PATH , P.PIC_NAME , P.THUM_NAME , P.DOWN_CNT , P.BOARD_ID , P.USER_ID , U.PROFILE_IMG,
	       row_number() over(order by P.PIC_NUM desc)as rNum
	        FROM PICTURE P , USERS U, PICBOARD B
	        WHERE   P.USER_ID = U.USER_ID
                and p.BOARD_ID = B.BOARD_ID
                and B.DEL_YN = 'n' 
            )mb 
	    where rNum between #{startNum} and #{endNum}
	    order by PIC_NUM desc
		    )
		)
		SELECT * FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)
	</select>
	
	<select id="veryLikeImgs" resultType="kr.ddit.kixiv.picture.vo.Picture">
		WITH T AS(
			SELECT PIC_NUM , PIC_PATH ,PIC_NAME ,THUM_NAME ,DOWN_CNT , BOARD_ID , USER_ID , PROFILE_IMG  FROM(
	        select  PIC_NUM , PIC_PATH ,PIC_NAME ,THUM_NAME ,DOWN_CNT , BOARD_ID , USER_ID , PROFILE_IMG ,likey_cnt
			from (
				SELECT  P.PIC_NUM ,P.PIC_PATH ,P.PIC_NAME ,P.THUM_NAME ,P.DOWN_CNT ,P.BOARD_ID , P.USER_ID ,U.PROFILE_IMG,B.DEL_YN,
		                (SELECT COUNT(*) FROM LIKEY L WHERE P.PIC_NUM = L.PIC_NUM) likey_cnt,
		                row_number() over(order by P.PIC_NUM desc)as rNum
		        FROM PICTURE P , USERS U, PICBOARD B
		        WHERE   P.USER_ID = U.USER_ID
	             and p.BOARD_ID = B.BOARD_ID
	             and B.DEL_YN = 'n' 
	            )mb
	        where rNum between #{startNum} and #{endNum}
	        ORDER BY likey_cnt DESC
			    )
			)
			SELECT * FROM T U
			WHERE U.PIC_NUM = (
			    SELECT MAX(V.PIC_NUM)
			    FROM   T V
			    WHERE  V.BOARD_ID = U.BOARD_ID
			)
	</select>
	
	<select id="getFollowListCnt" resultType="int">
     WITH T AS(
		SELECT PIC_NUM, PIC_PATH, PIC_NAME, DOWN_CNT, BOARD_ID, USER_ID, PROFILE_IMG FROM(
        SELECT  P.PIC_NUM ,
            P.PIC_PATH ,
            P.PIC_NAME ,
            P.THUM_NAME ,
            P.DOWN_CNT ,
            P.BOARD_ID ,
            P.USER_ID ,
            U.PROFILE_IMG
        FROM PICTURE P , USERS U,  PICBOARD B
        where p.user_id = u.user_id
        AND P.BOARD_ID =B.BOARD_ID
        AND B.DEL_YN = 'n'
        and P.USER_ID in (SELECT F.FROM_ID FROM FOLLOWING F  WHERE F.TO_ID = #{user_id})
        ORDER BY P.PIC_NUM DESC
		    )
		)
		SELECT count(*) FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
	)
        
	</select>

	<select id="followImgs" resultType="kr.ddit.kixiv.picture.vo.Picture">
	  WITH T AS(
		SELECT PIC_NUM , PIC_PATH ,PIC_NAME ,THUM_NAME ,DOWN_CNT , BOARD_ID , USER_ID , PROFILE_IMG  FROM(
                   select  PIC_NUM, PIC_PATH, PIC_NAME, THUM_NAME, DOWN_CNT, BOARD_ID, USER_ID, PROFILE_IMG
	        	from(
		            SELECT  P.PIC_NUM , P.PIC_PATH ,P.PIC_NAME , P.THUM_NAME ,P.DOWN_CNT ,P.BOARD_ID , P.USER_ID ,U.PROFILE_IMG, B.DEL_YN
		            ,row_number() over(order by P.PIC_NUM desc)as rNum
		            FROM PICTURE P , USERS U, PICBOARD B
		            WHERE   p.user_id = u.user_id 
		            and p.user_id = u.user_id 
	                and P.USER_ID in  (SELECT F.FROM_ID FROM FOLLOWING F  WHERE F.TO_ID = #{user_id}) 
                    and P.USER_ID = U.USER_ID 
                    and P.BOARD_ID = B.BOARD_ID
                    and B.DEL_YN = 'n'
		        )mb
	        where rNum between #{startNum} and #{endNum}
			ORDER BY PIC_NUM DESC
		    )
		)
		SELECT * FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)
	</select>
		
	<select id="getMyListCnt" resultType="int">
		WITH T AS(
		SELECT PIC_NUM, PIC_PATH, BOARD_ID, USER_ID FROM(
                SELECT P.PIC_NUM, P.PIC_PATH, P.BOARD_ID, P.USER_ID
                    FROM PICTURE P, PICBOARD B
                WHERE  P.USER_ID = #{tkd753}
                AND P.BOARD_ID =B.BOARD_ID
                AND B.DEL_YN = 'n'
		    )
		)
		SELECT count(*) FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)

	</select>
	
	<select id="getPicture" resultType="kr.ddit.kixiv.picture.vo.Picture">
		select* from PICTURE where board_id = #{board_id}
	</select>
	
	<delete id="deleteChangeImg">
		   DELETE FROM PICTURE 
		   WHERE pic_num = #{pic_num}
	</delete>
	
	<delete id="deletePicture">
			DELETE FROM PICTURE 
		   WHERE board_id = #{board_id}
	</delete>
	
	
	<select id="newTopImg" resultType="kr.ddit.kixiv.picture.vo.Picture">
		SELECT PIC_PATH, Board_Id
		    FROM
		    (
		        SELECT U.USER_ID, U.JOIN_DATE 
		        FROM USERS U
		        WHERE  U.JOIN_DATE BETWEEN TO_DATE(add_months(sysdate, -6)) AND TO_DATE(SYSDATE, 'YYYY-MM-DD')   
		    )US, 
		    (
		        SELECT P.USER_ID AS USER_ID, P.PIC_NUM ,PIC_PATH,Board_Id, COUNT(P.USER_ID) CNT
		        FROM PICTURE P, LIKEY L 
		        WHERE P.PIC_NUM = L.PIC_NUM    
		        GROUP BY P.USER_ID, P.PIC_NUM, PIC_PATH, Board_Id
		    )C
		     
		    WHERE US.USER_ID(+) = C.USER_ID 
		 <![CDATA[
            AND rownum < 6
        ]]>    
	    ORDER BY CNT DESC
	</select>
	
	<select id="recomImg" resultType="kr.ddit.kixiv.picture.vo.Picture">
		WITH T AS(
		SELECT PIC_NUM, PIC_PATH, BOARD_ID, USER_ID, PROFILE_IMG FROM(
       		select p1.pic_num, p1.PIC_PATH, p1.user_id, t.profile_img, t.board_id
            from(
                select l.like_seq, p.pic_num, b.board_id, l.user_id, p.PIC_PATH, u.profile_img
                from likey l, picture p, picboard b, users u
                where l.pic_num = p.PIC_NUM
                and p.BOARD_ID = b.BOARD_ID
                and p.USER_ID = u.USER_ID
                and l.user_id = #{user_id}
            )t, picture p1
            where t.board_id = p1.board_id
            group by p1.pic_num, p1.user_id, p1.PIC_PATH, t.profile_img, t.board_id
		    )
		)
		SELECT * FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)
	</select>
	
	<select id="getRecomListCnt" resultType="integer">
	WITH T AS(
			SELECT PIC_NUM, PIC_PATH, BOARD_ID, USER_ID, PROFILE_IMG FROM(
	       		select p1.pic_num, p1.PIC_PATH, p1.user_id, t.profile_img, t.board_id
	            from(
	                select l.like_seq, p.pic_num, b.board_id, l.user_id, p.PIC_PATH, u.profile_img
	                from likey l, picture p, picboard b, users u
	                where l.pic_num = p.PIC_NUM
	                and p.BOARD_ID = b.BOARD_ID
	                and p.USER_ID = u.USER_ID
	                and l.user_id = #{user_id}
	            )t, picture p1
	            where t.board_id = p1.board_id
	            group by p1.pic_num, p1.user_id, p1.PIC_PATH, t.profile_img, t.board_id
			    )
			)
			SELECT count(*) FROM T U
			WHERE U.PIC_NUM = (
			    SELECT MAX(V.PIC_NUM)
			    FROM   T V
			    WHERE  V.BOARD_ID = U.BOARD_ID
			)

	</select>
	
	<select id="RecomImgs" resultType="kr.ddit.kixiv.picture.vo.Picture">
 	WITH T AS(
		SELECT PIC_NUM , PIC_PATH  , BOARD_ID , PROFILE_IMG  FROM(
            select p1.pic_num, p1.PIC_PATH, t.BOARD_ID, p1.user_id, t.profile_img
            from(
                select l.like_seq, p.pic_num, b.board_id, l.user_id, p.PIC_PATH, u.profile_img,row_number() over(order by P.PIC_NUM desc)as rNum
                from likey l, picture p, picboard b, users u
                where l.pic_num = p.PIC_NUM
                and p.BOARD_ID = b.BOARD_ID
                and p.USER_ID = u.USER_ID
                and l.user_id = #{user_id}            
            )t, picture p1
            where t.board_id = p1.board_id
            and rNum between #{startNum} and #{endNum}
            group by p1.pic_num, p1.user_id,t.BOARD_ID, p1.PIC_PATH, t.profile_img
		    )
		)
		SELECT * FROM T U
		WHERE U.PIC_NUM = (
		    SELECT MAX(V.PIC_NUM)
		    FROM   T V
		    WHERE  V.BOARD_ID = U.BOARD_ID
		)
	</select>
</mapper>