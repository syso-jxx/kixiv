<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ddit.kixiv.gallery.mapper.GalleryDao">
				   
	<select id="getGalleryRentList" resultType="HashMap">
	    SELECT 
	        S.RNUM, 
	        S.rent_seq AS rent_seq, 
	        S.gallery_name AS gallery_name,
	        S.gallery_zip AS gallery_zip, 
	        S.gallery_thum AS gallery_thum,
	        S.gallery_add1 AS gallery_add1, 
	        S.gallery_add2 AS gallery_add2, 
	        S.gallery_img AS gallery_img,
	        S.rent_sdate AS rent_sdate, 
	        S.rent_edate AS rent_edate, 
	        S.user_id AS user_id, 
	        S.rent_status AS rent_status
	    FROM (
	        SELECT @ROWNUM:=@ROWNUM+1 AS RNUM, T.*
	        FROM (
	            SELECT b.rent_seq AS rent_seq
	                , a.gallery_name AS gallery_name
	                , a.gallery_zip AS gallery_zip
	                , a.gallery_thum AS gallery_thum
	                , a.gallery_add1 AS gallery_add1
	                , a.gallery_add2 AS gallery_add2
	                , a.gallery_img
	                , DATE_FORMAT(b.rent_sdate, '%Y-%m-%d') AS rent_sdate
	                , DATE_FORMAT(b.rent_edate, '%Y-%m-%d') AS rent_edate
	                , a.user_id AS user_id
	                , b.rent_status AS rent_status
	            FROM gallery a, rent b
	            WHERE a.gallery_num = b.gallery_num
	            ORDER BY b.rent_seq DESC
	        ) T, (SELECT @ROWNUM:=0) R
	        WHERE T.gallery_name LIKE CONCAT('%', #{keyword}, '%')
	    ) S
	    WHERE S.RNUM BETWEEN (#{pageNum} * 10) - 9 AND (#{pageNum} * 10)
	</select>
	
	<select id="count" resultType="int">
	    SELECT 
	        COUNT(*) AS cnt 
	    FROM 
	        rent a, gallery b
	    WHERE
	        a.gallery_num = b.gallery_num
	    <if test="keyword != null and keyword != ''">
	    AND gallery_name LIKE CONCAT('%', #{keyword}, '%')
	    </if>
	</select>
	
	<select id="selectSearchCount" resultType="int">
	    SELECT COUNT(*) AS cnt 
	    FROM gallery
	</select>
	
	<select id="getRent" resultType="map">
	    SELECT 
	        a.rent_seq AS rent_seq, 
	        DATE_FORMAT(a.rent_sdate,'%Y-%m-%d') AS rent_sdate,
	        DATE_FORMAT(a.rent_edate,'%Y-%m-%d') AS rent_edate, 
	        a.rent_content AS rent_content, 
	        a.fund_yn AS fund_yn,
	        a.rent_price AS rent_price, 
	        a.rent_status AS rent_status, 
	        a.rentdate AS rentdate, 
	        a.del_yn AS del_yn, 
	        a.gallery_num AS gallery_num,
	        b.gallery_name AS gallery_name, 
	        b.gallery_zip AS gallery_zip, 
	        b.gallery_add1 AS gallery_add1, 
	        b.gallery_add2 AS gallery_add2, 
	        b.gallery_tel AS gallery_tel, 
	        b.gallery_intro AS gallery_intro,  
	        b.gallery_img AS gallery_img, 
	        b.homepage AS homepage, 
	        b.user_id AS user_id,
	        c.phone AS phone
	    FROM
	        rent a, gallery b, users c
	    WHERE 
	        a.gallery_num = b.gallery_num
	    AND
	        rent_seq = #{rent_seq}
	    AND
	        b.user_id = c.user_id    
	</select>
	
	<select id="galleryList" resultType="kr.ddit.kixiv.gallery.vo.GalleryVO">
	    SELECT 
	        gallery_num,
	        gallery_name, 
	        gallery_zip, 
	        gallery_add1, 
	        gallery_add2, 
	        gallery_tel, 
	        gallery_intro, 
	        gallery_img, 
	        gallery_path, 
	        gallery_thum, 
	        homepage, 
	        user_id, 
	        delete_yn
	    FROM gallery
	    WHERE user_id = #{user_id}
	    AND delete_yn = 'n'
	    ORDER BY gallery_num
	</select>
	
	<select id="addressCheck" resultType="kr.ddit.kixiv.gallery.vo.GalleryVO">
	    SELECT * 
	    FROM gallery
	    WHERE gallery_add1 = #{gallery_add1}
	</select>
	
	<select id="getGrpCount" resultType="int">
	    SELECT COUNT(*) 
	    FROM cmt
	    WHERE grp = #{grp}
	</select>
	
	<select id="getCountGB" resultType="int">
	    SELECT COUNT(*) 
	    FROM good_bad
	    WHERE cmt_id = #{cmt_id}
	</select>
	
	<insert id="addGallery">
	    INSERT INTO gallery(gallery_num, gallery_name, gallery_zip, gallery_add1, gallery_add2, gallery_tel, 
	    gallery_intro, gallery_img, gallery_path, gallery_thum, user_id, delete_yn, homepage)
	    VALUES((SELECT COALESCE(MAX(gallery_num), 0) + 1 FROM gallery), #{gallery_name}, #{gallery_zip}, #{gallery_add1}, #{gallery_add2}, #{gallery_tel}, #{gallery_intro}, #{gallery_img}, 'path', 'thum', #{user_id}, 'n',
	    <choose>
	        <when test="homepage == null">
	            '')
	        </when>
	        <otherwise>
	            #{homepage})
	        </otherwise>
	    </choose>
	</insert>
	
	<update id="modifyGallery">
	    UPDATE gallery 
	    SET gallery_zip = #{gallery_zip}, 
	        gallery_add1 = #{gallery_add1}, 
	        gallery_add2 = #{gallery_add2}, 
	        gallery_tel = #{gallery_tel},
	        gallery_intro = #{gallery_intro}, 
	        gallery_img = #{gallery_img},
	        homepage = #{homepage}
	    WHERE gallery_num = #{gallery_num}
	</update>
	
	<select id="myGalleryDetail" resultType="kr.ddit.kixiv.gallery.vo.GalleryVO">
	    SELECT * FROM gallery
	    WHERE gallery_num = #{gallery_num}
	</select>
	
	<update id="deleteGallery">
	    UPDATE gallery
	    SET delete_yn = 'y'
	    WHERE gallery_num = #{gallery_num}
	</update>
	
	<insert id="rentReqVO">
	    INSERT 
	    INTO gallery_rent
	        (rent_num, cancel_status, rent_tel, rent_seq, user_id, rent_req_date, rent_name, rent_email, rent_imp_uid, rent_pg)
	    VALUES (#{rent_num}, 'n', #{rent_tel}, #{rent_seq}, #{user_id}, NOW(), #{rent_name}, #{rent_email}, #{rent_imp_uid}, '이니시스')
	</insert>
	
	<update id="rentReqStVO">
	    UPDATE rent
	    SET rent_status = 'n'
	    WHERE rent_seq = #{rent_seq}
	</update>
	
	<update id="rentRefundVO">
	    UPDATE gallery_rent
	    SET cancel_status = 'y'
	    WHERE rent_num = #{rent_num}
	</update>
	
	<select id="galleryRentUserList" resultType="kr.ddit.kixiv.gallery.vo.GalleryRentVO"> 
	    SELECT 
	        a.rent_num AS rent_num, 
	        a.cancel_status AS cancel_status, 
	        a.rent_tel AS rent_tel, 
	        a.rent_seq AS rent_seq, 
	        a.user_id AS user_id, 
	        a.rent_req_date AS rent_req_date, 
	        a.rent_name AS rent_name, 
	        a.rent_email AS rent_email, 
	        a.rent_imp_uid AS rent_imp_uid, 
	        a.rent_pg AS rent_pg,
	        g.gallery_name AS gallery_name,
	        b.rent_status AS rent_status,
	        b.rent_sdate AS rent_sdate,
	        b.rent_edate AS rent_edate,
	        b.rent_price AS rent_price,
	        (SELECT c.phone FROM users c WHERE c.user_id = a.user_id) AS phone,
	        (SELECT c.email FROM users c WHERE c.user_id = a.user_id) AS email,
	        (SELECT c.name FROM users c WHERE c.user_id = a.user_id) AS name
	    FROM gallery_rent a, rent b, gallery g 
	    WHERE 1 = 1 
	    AND a.user_id = #{user_id}
	    AND a.rent_seq = b.rent_seq
	    AND g.gallery_num = b.gallery_num
	</select>
	
	<!-- 갤러리 회원 갤러리 렌트글 리스트 갯수 -->
	<select id="totalCount" resultType="int">
	    SELECT COUNT(*)
	    FROM(
	        SELECT b.rent_seq AS rent_seq
	            , a.gallery_name AS gallery_name
	            , a.gallery_zip AS gallery_zip
	            , a.gallery_thum AS gallery_thum
	            , a.gallery_add1 AS gallery_add1
	            , a.gallery_add2 AS gallery_add2
	            , DATE_FORMAT(b.rent_sdate, '%Y-%m-%d') AS rent_sdate
	            , DATE_FORMAT(b.rent_edate, '%Y-%m-%d') AS rent_edate
	            , a.user_id AS user_id
	            , b.rent_status AS rent_status
	        FROM gallery a, rent b
	        WHERE a.gallery_num = b.gallery_num
	        AND user_id = #{user_id}
	    ) AS subquery
	    <where>
	        <if test="keyword == 'today'">
	            rent_sdate = DATE_FORMAT(NOW(), '%Y-%m-%d')
	        </if>
	        <if test="keyword == 'week'">
	            rent_sdate BETWEEN DATE_FORMAT(DATE_SUB(NOW(), INTERVAL WEEKDAY(NOW()) DAY), '%Y-%m-%d') 
	            AND DATE_FORMAT(DATE_ADD(DATE_SUB(NOW(), INTERVAL WEEKDAY(NOW()) DAY), INTERVAL 6 DAY), '%Y-%m-%d')
	        </if>
	        <if test="keyword == 'month'">
	            LEFT(rent_sdate, 7) = DATE_FORMAT(NOW(), '%Y-%m')
	        </if>
	        <if test="keyword == 'year'">
	            LEFT(rent_sdate, 4) = DATE_FORMAT(NOW(), '%Y')
	        </if>
	        <if test="keyword == 'period'">
	            rent_sdate BETWEEN #{rent_period_start} AND #{rent_period_end}
	        </if>
	    </where>
	</select>
	
	<!-- 갤러리 회원 갤러리 렌트글 리스트 -->
	<select id="myGalleryRent" resultType="HashMap">
	    SELECT S.RNUM, S.rent_seq AS rent_seq, S.gallery_name AS gallery_name
	         , S.gallery_zip AS gallery_zip , S.gallery_thum AS gallery_thum
	         , S.gallery_add1 AS gallery_add1, S.gallery_add2 AS gallery_add2, S.gallery_img
	         , S.rent_sdate AS rent_sdate, S.rent_edate AS rent_edate, S.user_id AS user_id, S.rent_status AS rent_status
	    FROM(
	        SELECT @ROWNUM:=@ROWNUM+1 AS RNUM, T.*
	        FROM (
	            SELECT b.rent_seq AS rent_seq
	                , a.gallery_name AS gallery_name
	                , a.gallery_zip AS gallery_zip
	                , a.gallery_thum AS gallery_thum
	                , a.gallery_add1 AS gallery_add1
	                , a.gallery_add2 AS gallery_add2
	                , a.gallery_img
	                , DATE_FORMAT(b.rent_sdate, '%Y-%m-%d') AS rent_sdate
	                , DATE_FORMAT(b.rent_edate, '%Y-%m-%d') AS rent_edate
	                , a.user_id AS user_id
	                , b.rent_status AS rent_status
	            FROM gallery a, rent b
	            WHERE a.gallery_num = b.gallery_num
	            AND user_id = #{user_id}
	        ) T, (SELECT @ROWNUM:=0) R
	        <where>
	            <if test="keyword == 'today'">
	                T.rent_sdate = DATE_FORMAT(NOW(), '%Y-%m-%d')
	            </if>
	            <if test="keyword == 'week'">
	                T.rent_sdate BETWEEN DATE_FORMAT(DATE_SUB(NOW(), INTERVAL WEEKDAY(NOW()) DAY), '%Y-%m-%d') 
	                AND DATE_FORMAT(DATE_ADD(DATE_SUB(NOW(), INTERVAL WEEKDAY(NOW()) DAY), INTERVAL 6 DAY), '%Y-%m-%d')
	            </if>
	            <if test="keyword == 'month'">
	                LEFT(T.rent_sdate, 7) = DATE_FORMAT(NOW(), '%Y-%m')
	            </if>
	            <if test="keyword == 'year'">
	                LEFT(T.rent_sdate, 4) = DATE_FORMAT(NOW(), '%Y')
	            </if>
	            <if test="keyword == 'period'">
	                T.rent_sdate BETWEEN #{rent_period_start} AND #{rent_period_end}
	            </if>
	        </where>
	    ) S
	    WHERE S.RNUM BETWEEN (#{pageNum} * 10) - 9 AND (#{pageNum} * 10)
	</select>
	
	<!-- 일반회원 갤러리 렌트 리스트 갯수 -->
	<select id="getMyRentReqListCnt" resultType="int">
	    SELECT COUNT(*)
	    FROM (
	        SELECT DATE_FORMAT(b.rent_req_date, '%Y-%m-%d') AS rent_req_date
	         , a.user_id
	        FROM gallery a, gallery_rent b, rent c
	        WHERE a.gallery_num = c.gallery_num
	        AND b.user_id = #{user_id}
	        AND c.rent_seq = b.rent_seq
	    ) T
	    <where>
	        <if test="keyword == 'today'">
	            rent_req_date = DATE_FORMAT(NOW(), '%Y-%m-%d')
	        </if>
	        <if test="keyword == 'week'">
	            rent_req_date BETWEEN DATE_FORMAT(DATE_SUB(NOW(), INTERVAL WEEKDAY(NOW()) DAY), '%Y-%m-%d') 
	            AND DATE_FORMAT(DATE_ADD(DATE_SUB(NOW(), INTERVAL WEEKDAY(NOW()) DAY), INTERVAL 6 DAY), '%Y-%m-%d')
	        </if>
	        <if test="keyword == 'month'">
	            LEFT(rent_req_date, 7) = DATE_FORMAT(NOW(), '%Y-%m')
	        </if>
	        <if test="keyword == 'year'">
	            LEFT(rent_req_date, 4) = DATE_FORMAT(NOW(), '%Y')
	        </if>
	        <if test="keyword == 'period'">
	            rent_req_date BETWEEN #{rent_period_start} AND #{rent_period_end}
	        </if>
	    </where>
	</select>
	
	<!-- 일반회원 갤러리 렌트 리스트 -->
	<select id="getMyRentReqList" resultType="HashMap">
	    SELECT S.RNUM, S.gallery_name, S.rent_req_date, S.rent_status, S.rent_num, S.rent_imp_uid, S.cancel_status, S.user_id
	    FROM (
	        SELECT @rownum := @rownum + 1 AS RNUM, T.*
	        FROM (
	            SELECT a.gallery_name,
	                   DATE_FORMAT(b.rent_req_date, '%Y-%m-%d') AS rent_req_date,
	                   c.rent_status,
	                   b.rent_num,
	                   b.rent_imp_uid,
	                   b.cancel_status,
	                   a.user_id
	            FROM gallery a
	            JOIN gallery_rent b ON a.gallery_num = b.gallery_num
	            JOIN rent c ON c.rent_seq = b.rent_seq
	            WHERE b.user_id = #{user_id}
	        ) T, (SELECT @rownum := 0) AS init
	        <if test="keyword == 'today'">
	            WHERE DATE(b.rent_req_date) = CURDATE()
	        </if>
	        <if test="keyword == 'week'">
	            WHERE DATE(b.rent_req_date) BETWEEN CURDATE() - INTERVAL WEEKDAY(CURDATE()) DAY AND CURDATE() - INTERVAL WEEKDAY(CURDATE()) - 6 DAY
	        </if>
	        <if test="keyword == 'month'">
	            WHERE DATE_FORMAT(b.rent_req_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
	        </if>
	        <if test="keyword == 'year'">
	            WHERE DATE_FORMAT(b.rent_req_date, '%Y') = DATE_FORMAT(CURDATE(), '%Y')
	        </if>
	        <if test="keyword == 'period'">
	            WHERE DATE(b.rent_req_date) BETWEEN STR_TO_DATE(#{rent_period_start}, '%Y-%m-%d') AND STR_TO_DATE(#{rent_period_end}, '%Y-%m-%d')
	        </if>
	    ) S
	    WHERE S.RNUM BETWEEN (#{pageNum} - 1) * 10 + 1 AND #{pageNum} * 10
	</select>
	<!-- 한 항목 선택하기 -->
	<select id="oneitemPick" resultType="kr.ddit.kixiv.gallery.vo.GalleryRentVO">
	    SELECT u.name, s.rent_name, g.gallery_name, r.rent_sdate, r.rent_edate, r.rent_price, s.rent_imp_uid, s.cancel_status, s.rent_num
	    FROM gallery_rent s
	    JOIN rent r ON s.rent_seq = r.rent_seq
	    JOIN gallery g ON r.gallery_num = g.gallery_num
	    JOIN users u ON g.user_id = u.user_id
	    WHERE s.rent_num = #{rent_num}
	</select>
	
	<!-- 최대 렌트 시퀀스 선택하기 -->
	<select id="selectMaxRentSeq" resultType="int">
	    SELECT IFNULL(MAX(rent_seq), 0) AS rent_seq
	    FROM rent
	</select>
		
	<!-- 렌트 데이터 삽입하기 -->
	<insert id="writeRentVO">
	    INSERT INTO rent (
	        rent_seq, rent_sdate, rent_edate, rent_content, fund_yn, rent_price, rent_status, rentdate, del_yn, gallery_num
	    )
	    VALUES (
	        (SELECT IFNULL(MAX(rent_seq), 0) + 1 FROM rent),
	        #{rent_sdate}, #{rent_edate}, #{rent_content}, #{fund_yn}, #{rent_price}, 'y', NOW(), 'n', #{gallery_num}
	    )
	</insert>
	<!-- 렌트 데이터 선택하기 -->
	<select id="getRentVO" resultType="kr.ddit.kixiv.gallery.vo.RentVO">
	    SELECT *
	    FROM rent
	    WHERE rent_seq = #{rent_seq}
	</select>
	<!-- 갤러리 데이터 선택하기 -->
	<select id="getGalleryVO" resultType="kr.ddit.kixiv.gallery.vo.GalleryVO">
	    SELECT *
	    FROM gallery
	    WHERE gallery_num = #{gallery_num}
	</select>
	<!-- 갤러리 렌트 수정하기 -->
	<update id="galleryRentModify">
	    UPDATE rent
	    SET rent_sdate = #{rent_sdate}, rent_edate = #{rent_edate}, rent_content = #{rent_content}
	    WHERE rent_seq = #{rent_seq}
	</update>
	<!-- 갤러리 렌트 삭제하기 -->
	<delete id="galleryRentDelete">
	    DELETE FROM rent
	    WHERE rent_seq = #{rent_seq}
	</delete>
	<!-- good_bad 테이블에서 항목 삭제하기 -->
	<delete id="deleteGB">
	    DELETE FROM good_bad
	    WHERE cmt_id = #{cmt_id}
	</delete>
	<!-- 댓글 삭제하기 -->
	<delete id="delCmtVOComp">
	    DELETE FROM cmt
	    WHERE cmt_id = #{cmt_id}
	</delete>
	<!-- 갤러리 렌트 취소 요청 업데이트 -->
	<update id="galleryReqRefund">
	    UPDATE gallery_rent
	    SET cancel_status = 'r', cancel_date = NOW()
	    WHERE rent_num = #{rent_num}
	</update>
	<!-- 렌트 상태 업데이트 -->
	<update id="rentStatusUpdate">
	    UPDATE rent
	    SET rent_status = 'y'
	    WHERE rent_seq = #{rent_seq}
	</update>
	<!-- 렌트 상태 유효성 검사 -->
	<update id="galleryValidUser">
	    UPDATE rent
	    SET rent_status = 'e'
	    WHERE rent_seq IN (
	        SELECT rent_seq
	        FROM rent
	        WHERE NOW() > rent_sdate
	    )
	</update>
	<!-- 댓글 삭제 여부 확인 -->
	<select id="getDelYn" resultType="String">
	    SELECT del_yn
	    FROM cmt
	    WHERE grp = #{grp}
	</select>
	
	<!-- 댓글 ID 가져오기 -->
	<select id="getCmtId" resultType="int">
	    SELECT cmt_id
	    FROM cmt
	    WHERE grp = #{grp}
	</select>
</mapper>